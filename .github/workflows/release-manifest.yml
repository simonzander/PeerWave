name: Generate Release Manifest

on:
  release:
    types: [published]

jobs:
  generate-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate latest.json manifest
        run: |
          # Extract version from tag
          VERSION="${GITHUB_REF#refs/tags/v}"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Get release info from GitHub API
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${VERSION}")
          
          # Extract download URLs
          WINDOWS_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("windows")) | .browser_download_url')
          MACOS_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains("macos")) | .browser_download_url')
          RELEASE_NOTES=$(echo "$RELEASE_INFO" | jq -r '.body')
          
          # Read version config for compatibility info
          MIN_SERVER_VERSION=$(grep -oP 'min_server_version: "\K[^"]+' version_config.yaml)
          MAX_SERVER_VERSION=$(grep -oP 'max_server_version: "\K[^"]+' version_config.yaml)
          
          # Create latest.json
          cat > latest.json <<EOF
          {
            "version": "${VERSION}",
            "release_date": "${RELEASE_DATE}",
            "downloads": {
              "windows": "${WINDOWS_URL}",
              "macos": "${MACOS_URL}"
            },
            "compatibility": {
              "min_server_version": "${MIN_SERVER_VERSION}",
              "max_server_version": "${MAX_SERVER_VERSION}"
            },
            "changelog": $(echo "$RELEASE_NOTES" | jq -Rs .),
            "release_url": "https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          }
          EOF
          
          cat latest.json
      
      - name: Upload manifest to release
        uses: softprops/action-gh-release@v1
        with:
          files: latest.json
          tag_name: v${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
