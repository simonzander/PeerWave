name: Branch Checks

on:
  push:
    branches:
      - '**'  # All branches
      - '!main'  # Except main (handled by release workflow)
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  flutter-checks:
    name: Flutter Analysis & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
          dart format client/lib/config/version_info.dart
      
      - name: Run Flutter analyze
        working-directory: ./client
        run: flutter analyze --no-fatal-infos --no-fatal-warnings
      
      - name: Run Dart security audit
        working-directory: ./client
        continue-on-error: true
        run: |
          dart pub global activate pana
          dart pub global run pana --no-warning --source path .
      
      - name: Check Dart formatting
        working-directory: ./client
        run: dart format --set-exit-if-changed $(find . -name "*.dart" ! -name "version_info.dart" ! -path "*/build/*" ! -path "*/.dart_tool/*")
      
      - name: Build summary
        run: |
          echo "✅ Flutter analysis passed"
          echo "✅ Code formatting correct"
          echo "ℹ️  No artifacts published (branch build)"
  
  server-checks:
    name: Server Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Generate server version
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Lint
        working-directory: ./server
        run: npm run lint --if-present
      
      - name: Run tests
        working-directory: ./server
        run: npm test --if-present
      
      - name: Test server startup
        working-directory: ./server
        timeout-minutes: 1
        run: |
          timeout 10s node server.js || [ $? -eq 124 ]
          echo "✅ Server starts without errors"

  build-windows:
    name: Try Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Windows
        working-directory: ./client
        run: flutter build windows --release

  build-macos:
    name: Try Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build macOS
        working-directory: ./client
        run: flutter build macos --release

  build-android:
    name: Try Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Android APK
        working-directory: ./client
        run: flutter build apk --debug

  build-docker:
    name: Try Build Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Flutter Web
        working-directory: ./client
        run: |
          flutter pub get
          flutter build web --release
      
      - name: Test Docker Build
        run: docker compose build
  
  summary:
    name: Checks Summary
    runs-on: ubuntu-latest
    needs: [flutter-checks, server-checks, build-windows, build-macos, build-android, build-docker]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "### ✅ Branch Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter Analysis | ${{ needs.flutter-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Server Lint & Test | ${{ needs.server-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows Build | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Build | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Fail if any required check failed
          if [[ "${{ needs.flutter-checks.result }}" != "success" ]] || \
             [[ "${{ needs.server-checks.result }}" != "success" ]] || \
             [[ "${{ needs.build-windows.result }}" != "success" ]] || \
             [[ "${{ needs.build-macos.result }}" != "success" ]] || \
             [[ "${{ needs.build-android.result }}" != "success" ]] || \
             [[ "${{ needs.build-docker.result }}" != "success" ]]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed"
