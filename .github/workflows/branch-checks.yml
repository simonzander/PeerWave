name: Branch Checks

on:
  push:
    branches:
      - '**'  # All branches
      - '!main'  # Except main (handled by release workflow)
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

jobs:
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      client_changed: ${{ steps.detect.outputs.client_changed }}
      server_changed: ${{ steps.detect.outputs.server_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Detect changed folders
        id: detect
        run: |
          # Get the list of changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            # Handle new branches or null SHA for before
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              # For new branches, compare against main/origin default branch
              echo "New branch detected, comparing against origin/main"
              CHANGED_FILES=$(git diff --name-only origin/main...${{ github.sha }} 2>/dev/null || git show --name-only --pretty=format: ${{ github.sha }})
            else
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            fi
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if client or server folders changed
          CLIENT_CHANGED="false"
          SERVER_CHANGED="false"
          
          if echo "$CHANGED_FILES" | grep -q "^client/"; then
            CLIENT_CHANGED="true"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^server/"; then
            SERVER_CHANGED="true"
          fi
          
          echo "client_changed=$CLIENT_CHANGED" >> $GITHUB_OUTPUT
          echo "server_changed=$SERVER_CHANGED" >> $GITHUB_OUTPUT
          echo "Client changed: $CLIENT_CHANGED"
          echo "Server changed: $SERVER_CHANGED"

  flutter-checks:
    name: Flutter Analysis & Format
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.client_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
          dart format client/lib/config/version_info.dart
      
      - name: Run Flutter analyze
        working-directory: ./client
        run: flutter analyze --no-fatal-infos --no-fatal-warnings
      
      - name: Run Dart security audit
        working-directory: ./client
        continue-on-error: true
        run: |
          dart pub global activate pana
          dart pub global run pana --no-warning --source path .
      
      - name: Check Dart formatting
        working-directory: ./client
        run: dart format --set-exit-if-changed $(find . -name "*.dart" ! -name "version_info.dart" ! -path "*/build/*" ! -path "*/.dart_tool/*")
      
      - name: Build summary
        run: |
          echo "✅ Flutter analysis passed"
          echo "✅ Code formatting correct"
          echo "ℹ️  No artifacts published (branch build)"
  
  server-checks:
    name: Server Lint & Test
    runs-on: ubuntu-latest
    needs: detect
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Generate server version
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Lint
        working-directory: ./server
        run: npm run lint --if-present
      
      - name: Run tests
        working-directory: ./server
        run: npm test --if-present
      
      - name: Test server startup
        working-directory: ./server
        timeout-minutes: 1
        run: |
          timeout 10s node server.js || [ $? -eq 124 ]
          echo "✅ Server starts without errors"

  build-windows:
    name: Try Build Windows
    runs-on: windows-latest
    needs: detect
    if: needs.detect.outputs.client_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Windows
        working-directory: ./client
        run: flutter build windows --release

  build-macos:
    name: Try Build macOS
    runs-on: macos-latest
    needs: detect
    if: needs.detect.outputs.client_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build macOS
        working-directory: ./client
        run: flutter build macos --release

  build-android:
    name: Try Build Android
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.client_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Android APK
        working-directory: ./client
        run: flutter build apk --debug

  build-docker:
    name: Try Build Docker
    runs-on: ubuntu-latest
    needs: detect
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Generate version info
        run: |
          cd tools && dart pub get && cd ..
          dart tools/generate_version.dart
      
      - name: Build Flutter Web
        working-directory: ./client
        run: |
          flutter pub get
          flutter build web --release
      
      - name: Test Docker Build
        run: docker compose build
  
  summary:
    name: Checks Summary
    runs-on: ubuntu-latest
    needs: [detect, flutter-checks, server-checks, build-windows, build-macos, build-android, build-docker]
    if: always()
    steps:
      - name: Check results
        run: |
          CLIENT_CHANGED="${{ needs.detect.outputs.client_changed }}"
          
          echo "### ✅ Branch Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CLIENT_CHANGED" == "true" ]; then
            echo "**All checks ran (client changed)**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Server-only checks ran (client unchanged)**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Always show server checks
          echo "| Server Lint & Test | ${{ needs.server-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Show client checks only if client changed
          if [ "$CLIENT_CHANGED" == "true" ]; then
            echo "| Flutter Analysis | ${{ needs.flutter-checks.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Windows Build | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| macOS Build | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Android Build | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail if any required check failed
          FAILED=false
          
          # Always check server and docker
          if [[ "${{ needs.server-checks.result }}" != "success" ]] || \
             [[ "${{ needs.build-docker.result }}" != "success" ]]; then
            FAILED=true
          fi
          
          # Check client builds only if client changed
          if [ "$CLIENT_CHANGED" == "true" ]; then
            if [[ "${{ needs.flutter-checks.result }}" != "success" ]] || \
               [[ "${{ needs.build-windows.result }}" != "success" ]] || \
               [[ "${{ needs.build-macos.result }}" != "success" ]] || \
               [[ "${{ needs.build-android.result }}" != "success" ]]; then
              FAILED=true
            fi
          fi
          
          if [ "$FAILED" == "true" ]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed"
