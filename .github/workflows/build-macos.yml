name: Build macOS Desktop App

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install dependencies
        working-directory: ./client
        run: flutter pub get
      
      - name: Generate version info
        run: dart run tools/generate_version.dart
      
      - name: Build macOS app
        working-directory: ./client
        run: flutter build macos --release
      
      - name: Create DMG package
        run: |
          # Extract version from config
          VERSION=$(grep -oP 'version: "\K[^"]+' version_config.yaml | head -1)
          OUTPUT_NAME="PeerWave-${VERSION}-macos.dmg"
          
          # Install create-dmg if not available
          if ! command -v create-dmg &> /dev/null; then
            brew install create-dmg
          fi
          
          # Create DMG
          create-dmg \
            --volname "PeerWave" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "${OUTPUT_NAME}" \
            "client/build/macos/Build/Products/Release/peerwave_client.app"
          
          echo "Created package: ${OUTPUT_NAME}"
          echo "PACKAGE_NAME=${OUTPUT_NAME}" >> $GITHUB_ENV
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: ${{ env.PACKAGE_NAME }}
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PACKAGE_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
