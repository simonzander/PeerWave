services:
  # LiveKit SFU Server (with embedded TURN)
  peerwave-livekit:
    image: livekit/livekit-server:latest
    container_name: peerwave-livekit
    restart: unless-stopped
    ports:
      - "7880:7880"   # WebRTC (main)
      - "7881:7881"   # HTTP API
      - "7882:7882"   # WebRTC TCP fallback
      - "5349:5349"   # TURN/TLS (replaces Coturn)
      - "443:443/udp" # TURN/UDP (QUIC-compatible)
      - "40000-50000:40000-50000/udp"  # RTP port range - MAXIMUM 10001 ports
      - "50000-60000:50000-60000/udp"  # TURN Relay range - MAXIMUM 10001 ports
    volumes:
      - ./livekit-config.yaml:/livekit.yaml:ro
      - ./livekit-certs:/certs:ro  # SSL certificates for TURN
    environment:
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
    command: --config /livekit.yaml
    networks:
      - peerwave-network

  # PeerWave Node.js Server
  peerwave-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: peerwave-server
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    volumes:
      - ./server/db:/usr/src/app/db
      - ./server/cert:/usr/src/app/cert:ro
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PORT:-3000}
      # LiveKit Config
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://peerwave-livekit:7880}
      - LIVEKIT_TURN_DOMAIN=${LIVEKIT_TURN_DOMAIN:-localhost}  # For P2P ICE config
    # Resource Limits f√ºr Video Processing
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - peerwave-network
    depends_on:
      - peerwave-livekit

networks:
  peerwave-network:
    driver: bridge
